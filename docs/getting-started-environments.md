---
id: getting-started-environments
title: Environments
---

An environment is a coherent set of BOSH deployments on a specific BOSH director.
Enterprises usually have a name for environments (e.g. the DEV foundation) and we like to use the concept of environments to have a solid folder structure for BOSH deployments.

> **Environment**: a target environment where products are deployed to. Ex: dev, qa, prod

Usually there are two types of environments:

- *similar* environments: e.g. Cloud Foundry DEV and PROD
- *different* environments: e.g. Cloud Foundry and Concourse

The general setup of our files and folder simplifies the operation of *similar* environments, though the approach does not limit possibilities for *different* environments.


## Environment Organization

To separate generic and reusable from environment-specific parts, the files to deploy and configure an environment are spread across three folders:

- `base`: Generic, environment-independent files and scripts
- `environments`: Environment-specific files and scripts
- `state`: BOSH Deployment state

The reason for having 3 folders is to provide a separation of concerns with regards to files that are generic (and therefore applicable to all environments) i.e. `base` and files that are specific to a particular environments i.e. `environments`.

Lastly `state` only contains state and credential files generated by BOSH. As those need to be shared among multiple developers and automation pipelines, the credentials are stored in a Git repository to ease version-controlled sharing.

### Version Control

It is recommended to put all files under version control.
By using a version control system such as Git anyone can contribute to the different files in a defined workflow that fits well for your team and automation pipeline.

We recommend to put each of the three above concerns into a separate Git repository.
As a minimum, you should put the `state` into a different Git repository as it contains sensitive credentials and certificates.
You may use a tool such as `git-crypt` to [encrypt sensitive information in Git repositories](https://www.agwa.name/projects/git-crypt/).

### Naming

Depending on what you are deploying, you may prefix folders with a unique identifier.
For example, if you are deploying Concourse your folders might be named as follows:

```
├── concourse-base
├── concourse-environments
└── concourse-state
```

When working on the deployment you should check out all three folder to your local file system.


## Base

The *base* contains scripts and configuration files for the products which can be deployed on an environment. 
The files are grouped by product in their respective folder:

```txt
base
├── bosh
├── ci
├── cloud-config
├── cloud-foundry
├── concourse
├── database
└── minio
```

Next to the product folders, we have three additional folders:

- `bosh`: BOSH director scripts are placed under the bosh folder
- `ci`: Contains files related to automation pipelines.
- `cloud-config`: Files related to the [BOSH cloud config](TODO)

Each of the above folders may contain the following subfolders:

- `operations`: these are custom [operations files](TODO) (ops files) that will not change for each environment.
- `resources`: external resources, usually Git submodules. They are retrieved by the `git submodule update` command. By using git submodules, we can put external resources under version control, to know exactly which versions are being used.
- `tools`: useful helper scripts that are related to the product but not essentially part of it.

### Example: BOSH

All environment-independent files related to the deployment of the BOSH director are located under the `bosh` folder in the *base* package:

```
base
└── bosh
    ├── deploy.sh
    ├── operations
    ├── resources
    │   └── bosh-deployment
    └── smoke-test.sh
```

The main deploy script is `/base/bosh/deploy.sh`. 
This deploy script is typically triggered via Concourse from a pipeline using the task `deploy-bosh.yml` found under `/base/ci/tasks/deploy-bosh.yml`.

The official BOSH manifests files from the [bosh-deployment repository](https://github.com/cloudfoundry/bosh-deployment) are found in the git submodule at `/base/bosh/resources/bosh-deployment`.
By using submodules we can keep track of the specific versions of the repository and easily upgrade using standard Git tooling.

In addition to the deploy script we also define a smoke test script which is able to run from the Concourse pipeline.
The smoke tests are run after each deployment to test whether deploying the BOSH director was successful or not.
The pipeline should be tailored to notify the operations team of successful and erroneous deployments.


### Concourse Pipelines and Tasks

The Concourse Pipelines and Tasks can be found under the `ci` folder:

```
base
└── ci
    ├── pipelines
    └── tasks
```

[Concourse pipeline definitions](https://concourse-ci.org/pipelines.html) are stored in `/base/ci/pipelines`.
By default, we provide one pipeline per product that takes care of deploying and upgrading the respective product.

[Concourse task definitions](https://concourse-ci.org/tasks.html) are stored in `/base/ci/tasks` and contain reusable tasks which are used from the aforementioned pipelines.

> **Heads up**: We have one pipeline per product per environment that executes the deployment. That means that if we have three environments DEV, QA, and PROD with 4 products each we will have a total of 12 pipelines.

All pipelines for a specific environment belong to a single [Concourse team](https://concourse-ci.org/teams.html). 
Concourse controls access on a per-team basis allowing us to have operators that can operate a pipeline for one environment but not another.



## Environments

The *environments* folder contains settings which are specific to an environment.
The files are grouped by environment and product:


```
environments
├── automation
│   ├── bosh
│   └── concourse
├── dev
│   ├── bosh
│   ├── cloud-config
│   ├── cloud-foundry
│   ├── database
│   └── minio
└── prod
    ├── bosh
    ├── cloud-config
    ├── cloud-foundry
    ├── database
    └── minio
```

The above structure supports three environments:

- `automation`: to deploy a Concourse instance for automation purposes
- `dev`: to deploy a development Cloud Foundry foundation
- `prod`: to deploy a productive Cloud Foundry foundation

Note that each environment contains a `bosh` folder, as each environment is managed by a separate BOSH director.
The two Cloud Foundry environments additionally contain customizations for the [BOSH cloud config](https://bosh.io/docs/cloud-config/).

> **Heads up**: The scripts and configurations files in this repository are meant to be environment specific. 
> All scripts and configuration files which are generic should be kept in the `/base` folder.



## State

This repository contains the state and credential files generated by the BOSH deployment processes.
This means that for each environment two files `<ENV>-state.json` and `<ENV>-creds.yml` are stored here:

```
├── automation-creds.yml
├── automation-state.json
├── dev-creds.yml
├── dev-state.json
├── prod-creds.yml
└── prod-state.json
```

> **Heads up**: Besides when deploying the automation environment for the first time this repository **should not** usually be updated manually.
> Instead, the Concourse deployment pipelines take care to update the state respectively.

> **IMPORTANT**: Keep these files safe! They are key to recover any damaged environment. 
> They also contain the credentials to take full control of a BOSH director.